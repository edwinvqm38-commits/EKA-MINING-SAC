<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gesti√≥n de Invitaciones</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        color-scheme: light;
      }

      body {
        background: #f6f7fb;
        font-family: 'Segoe UI', Roboto, sans-serif;
      }

      .sidebar-app {
        position: relative;
        min-height: 100vh;
      }

      .card {
        border-radius: 14px;
        border: none;
      }

      .card.shadow-sm {
        box-shadow: 0 12px 24px -18px rgba(31, 41, 55, 0.45);
      }

      .nav-pills .nav-link {
        font-weight: 600;
        border-radius: 999px;
        background: #eef2ff;
        color: #3949ab;
        border: 1px solid transparent;
        transition: all 0.15s ease-in-out;
        padding-block: 0.55rem;
      }

      .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        color: #ffffff;
        box-shadow: 0 10px 18px -12px rgba(99, 102, 241, 0.85);
      }

      .tab-pane {
        min-height: 220px;
      }

      label.form-label {
        font-weight: 600;
        color: #1f2937;
      }

      .form-text {
        font-size: 0.75rem;
      }

      .input-group-text {
        font-weight: 600;
      }

      .status-badge {
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 999px;
        padding: 0.2rem 0.65rem;
      }

      .badge-soft-primary {
        background: rgba(59, 130, 246, 0.1);
        color: #1d4ed8;
      }

      .badge-soft-success {
        background: rgba(34, 197, 94, 0.12);
        color: #15803d;
      }

      .badge-soft-warning {
        background: rgba(250, 204, 21, 0.18);
        color: #b45309;
      }

      .badge-soft-secondary {
        background: rgba(99, 102, 241, 0.12);
        color: #4338ca;
      }

      .field-group-card {
        background: rgba(99, 102, 241, 0.08);
        border: 1px solid rgba(99, 102, 241, 0.18);
        border-radius: 14px;
      }

      .field-group-card .group-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #3730a3;
        margin-bottom: 0.35rem;
      }

      .field-group-card .group-description {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.75rem;
      }

      .loading-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(246, 247, 251, 0.85);
        z-index: 20;
      }

      .loading-overlay .overlay-box {
        background: #ffffff;
        padding: 1.25rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 24px -16px rgba(15, 23, 42, 0.45);
        text-align: center;
      }

      .loading-overlay .spinner-border {
        width: 2.5rem;
        height: 2.5rem;
      }

      .floating-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .floating-buttons .btn {
        flex: 1 1 auto;
        min-width: 48%;
      }

      @media (max-width: 480px) {
        .floating-buttons .btn {
          min-width: 100%;
        }
      }

      .form-control[readonly],
      .form-control[disabled],
      .form-select[disabled] {
        background-color: #f3f4f6;
      }
    </style>
  </head>
  <body>
    <div class="sidebar-app container-fluid py-3">
      <div class="d-flex align-items-start justify-content-between gap-2 mb-3 flex-wrap">
        <div>
          <h1 class="h5 fw-semibold mb-1">Gesti√≥n de Invitaciones</h1>
          <div class="text-muted small">Hoja configurada: <span class="fw-semibold" id="configuredSheet"><?!= sheetName ?></span></div>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary btn-sm" id="dictionaryButton" type="button">
            Diccionario columnas
          </button>
          <button class="btn btn-outline-secondary btn-sm" id="reloadButton" type="button">Recargar</button>
        </div>
      </div>

      <div id="alertContainer"></div>

      <div id="summaryCard" class="card shadow-sm mb-3 d-none">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between gap-2 flex-wrap">
            <div>
              <div class="text-uppercase text-muted small">Fila activa</div>
              <div class="fw-semibold" id="rowSummaryTitle"></div>
              <div class="text-muted small" id="rowSummarySubtitle"></div>
            </div>
            <span class="badge badge-soft-secondary" id="rowSummaryBadge"></span>
          </div>
          <p class="small text-body-secondary mt-2 mb-0" id="rowSummaryDescription"></p>
          <div class="d-flex flex-wrap gap-1 mt-2" id="rowSummaryStatuses"></div>
        </div>
      </div>

      <div id="formCard" class="card shadow-sm mb-3 d-none">
        <div class="card-body">
          <ul class="nav nav-pills nav-fill gap-2 mb-3" id="sectionTabs" role="tablist"></ul>
          <div class="tab-content" id="sectionTabContent"></div>
        </div>
      </div>

      <div id="actionsCard" class="card shadow-sm mb-3 d-none">
        <div class="card-body">
          <div class="floating-buttons mb-2">
            <button id="acceptButton" type="button" class="btn btn-primary">
              Aceptar y sincronizar
            </button>
            <button id="updateButton" type="button" class="btn btn-success">
              Actualizar
            </button>
            <button id="cancelButton" type="button" class="btn btn-outline-secondary">
              Cancelar
            </button>
            <button id="deleteButton" type="button" class="btn btn-outline-danger">
              Eliminar fila
            </button>
          </div>
          <div id="statusMessage" class="form-text mt-2"></div>
        </div>
      </div>

      <template id="adminTabTemplate">
        <div class="tab-pane fade" id="panel-admin" role="tabpanel" aria-labelledby="tab-admin">
          <div id="permissionsCard" class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                <div>
                  <h2 class="h6 fw-semibold mb-1">Administraci√≥n de accesos</h2>
                  <div class="text-muted small">
                    Gestiona roles, columnas visibles y estado de los usuarios registrados.
                  </div>
                </div>
                <div class="d-flex flex-wrap gap-2">
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    id="openPermissionsSheetButton"
                    type="button"
                  >
                    Abrir hoja de permisos
                  </button>
                </div>
              </div>

              <div id="permissionStatus" class="form-text mb-3"></div>

              <form id="permissionUserForm" class="row g-2 align-items-end">
                <div class="col-12 col-lg-4">
                  <label class="form-label" for="permissionUserEmail">Usuario (correo)</label>
                  <input
                    type="email"
                    class="form-control form-control-sm"
                    id="permissionUserEmail"
                    placeholder="usuario@empresa.com"
                    required
                  />
                </div>
                <div class="col-12 col-lg-3">
                  <label class="form-label" for="permissionUserPhone">Tel√©fono</label>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    id="permissionUserPhone"
                    placeholder="+51 900 000 000"
                  />
                </div>
                <div class="col-6 col-lg-2">
                  <label class="form-label" for="permissionUserRole">Rol</label>
                  <select class="form-select form-select-sm" id="permissionUserRole" required>
                    <option value="ADMIN">Administrador</option>
                    <option value="EDITOR">Editor</option>
                    <option value="LECTOR">Lector</option>
                  </select>
                </div>
                <div class="col-6 col-lg-2">
                  <label class="form-label" for="permissionUserStatus">Estado</label>
                  <select class="form-select form-select-sm" id="permissionUserStatus">
                    <option value="Habilitado">Habilitado</option>
                    <option value="Deshabilitado">Deshabilitado</option>
                  </select>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label" for="permissionUserNotes">Notas</label>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    id="permissionUserNotes"
                    placeholder="Observaciones"
                  />
                </div>
                <div class="col-6 col-lg-3 text-lg-end">
                  <button
                    type="submit"
                    class="btn btn-primary btn-sm w-100"
                    id="permissionUserSubmitButton"
                  >
                    Registrar
                  </button>
                </div>
                <div class="col-6 col-lg-3 text-lg-end">
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100"
                    id="permissionUserResetButton"
                  >
                    Limpiar
                  </button>
                </div>
              </form>

              <div class="table-responsive small mt-3">
                <table class="table table-sm align-middle mb-3">
                  <thead>
                    <tr>
                      <th scope="col">Correo</th>
                      <th scope="col">Tel√©fono</th>
                      <th scope="col">Rol</th>
                      <th scope="col">Estado</th>
                      <th scope="col">Notas</th>
                      <th scope="col" class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="permissionUserTableBody"></tbody>
                </table>
              </div>

              <hr class="my-3" />

              <div class="mb-2">
                <h3 class="h6 fw-semibold mb-1">Visibilidad de columnas</h3>
                <div class="text-muted small">
                  Selecciona un usuario y activa las columnas que podr√° visualizar en la hoja
                  <span class="fw-semibold"><?!= sheetName ?></span>.
                </div>
              </div>

              <div class="row g-2 align-items-end mb-3">
                <div class="col-12 col-lg-6">
                  <label class="form-label" for="columnPermissionUser">Usuario</label>
                  <select id="columnPermissionUser" class="form-select form-select-sm">
                    <option value="">Selecciona un usuario‚Ä¶</option>
                  </select>
                </div>
                <div class="col-12 col-lg-6 text-lg-end">
                  <button id="columnPermissionSaveButton" type="button" class="btn btn-primary btn-sm">
                    Guardar visibilidad
                  </button>
                </div>
              </div>

              <div id="columnPermissionList" class="row g-2"></div>
            </div>
          </div>
        </div>
      </template>

      <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="overlay-box">
          <div class="spinner-border text-primary" role="status"></div>
          <div id="loadingMessage" class="small mt-2 fw-semibold text-primary">
            Procesando‚Ä¶
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="optionManagerModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="optionManagerTitle">Eliminar valor</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" for="optionManagerSelect">Selecciona el valor a eliminar</label>
              <select id="optionManagerSelect" class="form-select"></select>
            </div>
            <div class="alert alert-warning small mb-0" role="alert">
              Se eliminar√° el valor seleccionado de todas las filas de la hoja
              <span class="fw-semibold"><?!= sheetName ?></span>.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="button" class="btn btn-danger" id="optionManagerConfirm">Eliminar valor</button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const FIELD_SECTIONS = (() => {
        try {
          const data = <?!= fieldSectionsJson ?>;
          if (!Array.isArray(data)) {
            throw new Error('FIELD_SECTIONS no es array');
          }
          return data;
        } catch (error) {
          console.error('No se pudieron cargar las secciones del formulario.', error);
          return [
            {
              id: 'general',
              title: 'General',
              description: 'Campos b√°sicos de la invitaci√≥n.',
              fields: [],
            },
          ];
        }
      })();
      const SHEET_NAME = <?!= JSON.stringify(sheetName) ?>;
      const DICTIONARY_SHEET_NAME = <?!= JSON.stringify(dictionarySheetName) ?>;
      const PERMISSIONS_SHEET_NAME = <?!= JSON.stringify(permissionsSheetName) ?>;
      const COLUMN_PERMISSION_SHEET_NAME = <?!= JSON.stringify(columnPermissionSheetName) ?>;
      const CUSTOM_OPTION_VALUE = '__custom_option__';
      const CUSTOM_OPTION_REMOVE = '__remove_option__';
      const FIELD_LOOKUP = buildFieldLookup(FIELD_SECTIONS);

      const state = {
        rowNumber: null,
        values: {},
        baseline: {},
        loading: false,
        options: {},
        contactDirectory: {},
        permissions: {
          canEdit: true,
          canSync: true,
          canDelete: true,
          canManageAccess: false,
          role: '',
          email: '',
        },
        permissionAdmin: {
          users: [],
          columns: [],
          matrix: {},
          selectedEmail: '',
          loaded: false,
          loading: false,
          editingEmail: '',
        },
        optionRemoval: {
          alias: '',
          options: [],
          previousValue: '',
        },
        optionModalInstance: null,
      };

      const elements = {
        alertContainer: document.getElementById('alertContainer'),
        summaryCard: document.getElementById('summaryCard'),
        summaryTitle: document.getElementById('rowSummaryTitle'),
        summarySubtitle: document.getElementById('rowSummarySubtitle'),
        summaryBadge: document.getElementById('rowSummaryBadge'),
        summaryDescription: document.getElementById('rowSummaryDescription'),
        summaryStatuses: document.getElementById('rowSummaryStatuses'),
        formCard: document.getElementById('formCard'),
        actionsCard: document.getElementById('actionsCard'),
        tabs: document.getElementById('sectionTabs'),
        tabContent: document.getElementById('sectionTabContent'),
        reloadButton: document.getElementById('reloadButton'),
        dictionaryButton: document.getElementById('dictionaryButton'),
        acceptButton: document.getElementById('acceptButton'),
        updateButton: document.getElementById('updateButton'),
        cancelButton: document.getElementById('cancelButton'),
        deleteButton: document.getElementById('deleteButton'),
        statusMessage: document.getElementById('statusMessage'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        loadingMessage: document.getElementById('loadingMessage'),
        permissionsCard: document.getElementById('permissionsCard'),
        permissionStatus: document.getElementById('permissionStatus'),
        permissionUserForm: document.getElementById('permissionUserForm'),
        permissionUserEmail: document.getElementById('permissionUserEmail'),
        permissionUserPhone: document.getElementById('permissionUserPhone'),
        permissionUserRole: document.getElementById('permissionUserRole'),
        permissionUserStatus: document.getElementById('permissionUserStatus'),
        permissionUserNotes: document.getElementById('permissionUserNotes'),
        permissionUserSubmitButton: document.getElementById('permissionUserSubmitButton'),
        permissionUserResetButton: document.getElementById('permissionUserResetButton'),
        permissionUserTableBody: document.getElementById('permissionUserTableBody'),
        openPermissionsSheetButton: document.getElementById('openPermissionsSheetButton'),
        columnPermissionUser: document.getElementById('columnPermissionUser'),
        columnPermissionList: document.getElementById('columnPermissionList'),
        columnPermissionSaveButton: document.getElementById('columnPermissionSaveButton'),
        adminTabTemplate: document.getElementById('adminTabTemplate'),
        adminTabItem: null,
        adminTabButton: null,
        adminTabPane: null,
        optionModal: document.getElementById('optionManagerModal'),
        optionModalTitle: document.getElementById('optionManagerTitle'),
        optionModalSelect: document.getElementById('optionManagerSelect'),
        optionModalConfirm: document.getElementById('optionManagerConfirm'),
      };

      const tabInstances = {};

      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (!Array.isArray(FIELD_SECTIONS)) {
            throw new Error('FIELD_SECTIONS no es array');
          }
        } catch (error) {
          console.error('FIELD_SECTIONS inv√°lido durante la carga del panel.', error);
        }

        document.title = 'Gesti√≥n de Invitaciones';
        buildTabs();
        attachAdminTab();
        refreshAdminElementReferences();
        initializeStaticOptions();
        attachEventHandlers();
        if (elements.optionModal) {
          state.optionModalInstance = new bootstrap.Modal(elements.optionModal);
          elements.optionModal.addEventListener('hidden.bs.modal', resetOptionModalState);
        }
        loadContext();
      });

      function buildTabs() {
        elements.tabs.innerHTML = '';
        elements.tabContent.innerHTML = '';
        FIELD_SECTIONS.forEach((section, index) => {
          const isActive = index === 0;
          const tabId = `tab-${section.id}`;
          const panelId = `panel-${section.id}`;

          const navItem = document.createElement('li');
          navItem.className = 'nav-item';
          navItem.role = 'presentation';

          const button = document.createElement('button');
          button.className = `nav-link${isActive ? ' active' : ''}`;
          button.id = tabId;
          button.type = 'button';
          button.setAttribute('data-bs-toggle', 'pill');
          button.setAttribute('data-bs-target', `#${panelId}`);
          button.setAttribute('role', 'tab');
          button.setAttribute('aria-controls', panelId);
          button.setAttribute('aria-selected', String(isActive));
          button.textContent = section.title;

          navItem.appendChild(button);
          elements.tabs.appendChild(navItem);

          const pane = document.createElement('div');
          pane.className = `tab-pane fade${isActive ? ' show active' : ''}`;
          pane.id = panelId;
          pane.setAttribute('role', 'tabpanel');
          pane.setAttribute('aria-labelledby', tabId);

          if (section.description) {
            const description = document.createElement('p');
            description.className = 'small text-muted mb-3';
            description.textContent = section.description;
            pane.appendChild(description);
          }

          const row = document.createElement('div');
          row.className = 'row g-3';
          row.dataset.sectionId = section.id;
          const groupContainers = {};

          section.fields.forEach((field) => {
            if (field.hidden) {
              return;
            }
            const fieldElement = createFieldElement(field);
            if (field.group) {
              const groupRow = ensureGroupContainer(row, groupContainers, field);
              groupRow.appendChild(fieldElement);
            } else {
              row.appendChild(fieldElement);
            }
          });

          pane.appendChild(row);
          elements.tabContent.appendChild(pane);
        });
      }

      function attachAdminTab() {
        if (elements.adminTabItem || !elements.tabs || !elements.tabContent) {
          return;
        }
        const template = elements.adminTabTemplate;
        if (!template) {
          return;
        }
        const navItem = document.createElement('li');
        navItem.className = 'nav-item';
        const button = document.createElement('button');
        button.className = 'nav-link';
        button.id = 'tab-admin';
        button.type = 'button';
        button.setAttribute('data-bs-toggle', 'pill');
        button.setAttribute('data-bs-target', '#panel-admin');
        button.setAttribute('role', 'tab');
        button.setAttribute('aria-controls', 'panel-admin');
        button.setAttribute('aria-selected', 'false');
        button.textContent = 'Administraci√≥n de accesos';
        navItem.appendChild(button);
        elements.tabs.appendChild(navItem);
        elements.adminTabItem = navItem;
        elements.adminTabButton = button;

        if (!document.getElementById('panel-admin')) {
          const fragment = template.content ? template.content.cloneNode(true) : null;
          if (fragment) {
            elements.tabContent.appendChild(fragment);
          }
        }
        elements.adminTabPane = document.getElementById('panel-admin');
      }

      function refreshAdminElementReferences() {
        elements.permissionsCard = document.getElementById('permissionsCard');
        elements.permissionStatus = document.getElementById('permissionStatus');
        elements.permissionUserForm = document.getElementById('permissionUserForm');
        elements.permissionUserEmail = document.getElementById('permissionUserEmail');
        elements.permissionUserPhone = document.getElementById('permissionUserPhone');
        elements.permissionUserRole = document.getElementById('permissionUserRole');
        elements.permissionUserStatus = document.getElementById('permissionUserStatus');
        elements.permissionUserNotes = document.getElementById('permissionUserNotes');
        elements.permissionUserSubmitButton = document.getElementById('permissionUserSubmitButton');
        elements.permissionUserResetButton = document.getElementById('permissionUserResetButton');
        elements.permissionUserTableBody = document.getElementById('permissionUserTableBody');
        elements.openPermissionsSheetButton = document.getElementById('openPermissionsSheetButton');
        elements.columnPermissionUser = document.getElementById('columnPermissionUser');
        elements.columnPermissionList = document.getElementById('columnPermissionList');
        elements.columnPermissionSaveButton = document.getElementById('columnPermissionSaveButton');
        elements.adminTabPane = document.getElementById('panel-admin');
      }

      function ensureGroupContainer(sectionRow, cache, field) {
        const groupId = field.group;
        if (cache[groupId]) {
          return cache[groupId];
        }
        const wrapper = document.createElement('div');
        wrapper.className = 'col-12';
        wrapper.dataset.group = groupId;

        const card = document.createElement('div');
        card.className = 'field-group-card p-3 h-100';

        const title = document.createElement('div');
        title.className = 'group-title';
        title.textContent = field.groupLabel || field.label || groupId;
        card.appendChild(title);

        if (field.groupDescription) {
          const description = document.createElement('div');
          description.className = 'group-description mb-2';
          description.textContent = field.groupDescription;
          card.appendChild(description);
        }

        const innerRow = document.createElement('div');
        innerRow.className = 'row g-3 mt-1';
        card.appendChild(innerRow);

        wrapper.appendChild(card);
        sectionRow.appendChild(wrapper);
        cache[groupId] = innerRow;
        return innerRow;
      }

      function resolveColumnClass(field) {
        if (field.columnClass) {
          return field.columnClass;
        }
        if (field.width === 12) {
          return 'col-12';
        }
        if (field.width === 4) {
          return 'col-12 col-md-6 col-xl-4';
        }
        if (field.width === 3) {
          return 'col-12 col-md-4';
        }
        return 'col-12 col-lg-6';
      }

      function createFieldElement(field) {
        const columnClass = resolveColumnClass(field);
        const wrapper = document.createElement('div');
        wrapper.className = columnClass;
        wrapper.dataset.alias = field.alias;
        wrapper.dataset.type = field.valueType;

        const label = document.createElement('label');
        label.className = 'form-label';
        label.setAttribute('for', `field-${field.alias}`);
        label.textContent = field.label;
        if (field.required) {
          const requiredBadge = document.createElement('span');
          requiredBadge.className = 'badge bg-danger-subtle text-danger-emphasis ms-2 align-middle';
          requiredBadge.textContent = 'Requerido';
          label.appendChild(requiredBadge);
        }

        wrapper.appendChild(label);

        let control;
        switch (field.valueType) {
          case 'textarea':
            control = document.createElement('textarea');
            control.className = 'form-control';
            control.rows = field.rows || 3;
            break;
          case 'date':
            control = document.createElement('input');
            control.type = 'date';
            control.className = 'form-control';
            break;
          case 'time':
            control = document.createElement('input');
            control.type = 'time';
            control.className = 'form-control';
            break;
          case 'number':
            control = document.createElement('input');
            control.type = 'number';
            control.className = 'form-control';
            control.step = 'any';
            break;
          case 'select':
            control = document.createElement('select');
            control.className = 'form-select';
            if (field.allowCustom) {
              control.dataset.allowCustom = 'true';
            }
            break;
          case 'boolean':
            control = document.createElement('select');
            control.className = 'form-select';
            control.innerHTML = `
              <option value="">--</option>
              <option value="true">S√≠</option>
              <option value="false">No</option>
            `;
            break;
          case 'link':
            control = createLinkControl(field.alias);
            break;
          default:
            control = document.createElement('input');
            control.type = 'text';
            control.className = 'form-control';
            break;
        }

        if (field.valueType !== 'link') {
          control.id = `field-${field.alias}`;
          control.dataset.alias = field.alias;
          control.dataset.type = field.valueType;
          if (field.placeholder) {
            control.placeholder = field.placeholder;
          }
          if (field.readOnly) {
            control.readOnly = true;
            control.tabIndex = -1;
          }
          wrapper.appendChild(control);
        } else {
          wrapper.appendChild(control);
        }

        if (field.readOnly && field.valueType === 'select') {
          control.disabled = true;
        }

        if (field.helper) {
          const helper = document.createElement('div');
          helper.className = 'form-text';
          helper.textContent = field.helper;
          wrapper.appendChild(helper);
        }

        return wrapper;
      }

      function createLinkControl(alias) {
        const container = document.createElement('div');
        container.className = 'd-flex flex-column gap-2';

        const urlGroup = document.createElement('div');
        urlGroup.className = 'input-group';

        const urlLabel = document.createElement('span');
        urlLabel.className = 'input-group-text';
        urlLabel.textContent = 'URL';
        urlGroup.appendChild(urlLabel);

        const urlInput = document.createElement('input');
        urlInput.type = 'url';
        urlInput.className = 'form-control';
        urlInput.placeholder = 'https://‚Ä¶';
        urlInput.dataset.alias = alias;
        urlInput.dataset.role = 'link-url';
        urlGroup.appendChild(urlInput);

        const openButton = document.createElement('button');
        openButton.type = 'button';
        openButton.className = 'btn btn-outline-secondary';
        openButton.dataset.alias = alias;
        openButton.dataset.role = 'link-open';
        openButton.textContent = 'Abrir';
        urlGroup.appendChild(openButton);

        const textGroup = document.createElement('div');
        textGroup.className = 'input-group';

        const textLabel = document.createElement('span');
        textLabel.className = 'input-group-text';
        textLabel.textContent = 'Texto';
        textGroup.appendChild(textLabel);

        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.className = 'form-control';
        textInput.placeholder = 'Texto opcional';
        textInput.dataset.alias = alias;
        textInput.dataset.role = 'link-text';
        textGroup.appendChild(textInput);

        const clearButton = document.createElement('button');
        clearButton.type = 'button';
        clearButton.className = 'btn btn-outline-secondary';
        clearButton.dataset.alias = alias;
        clearButton.dataset.role = 'link-clear';
        clearButton.textContent = 'Limpiar';
        textGroup.appendChild(clearButton);

        container.appendChild(urlGroup);
        container.appendChild(textGroup);
        return container;
      }

      function buildFieldLookup(sections) {
        const lookup = {};
        sections.forEach((section) => {
          section.fields.forEach((field) => {
            lookup[field.alias] = field;
          });
        });
        return lookup;
      }

      function initializeStaticOptions() {
        Object.keys(FIELD_LOOKUP).forEach((alias) => {
          const field = FIELD_LOOKUP[alias];
          if (field.valueType !== 'select') {
            return;
          }
          const staticOptions = normalizeFieldOptions(field.options || []);
          if (!state.options[alias]) {
            state.options[alias] = staticOptions.slice();
          } else {
            mergeOptions(alias, staticOptions);
          }
        });
      }

      function normalizeFieldOptions(options) {
        if (!Array.isArray(options)) {
          return [];
        }
        return options
          .map((option) => {
            if (option === null || option === undefined) {
              return null;
            }
            if (typeof option === 'string' || typeof option === 'number') {
              const value = String(option).trim();
              if (!value) {
                return null;
              }
              return { value, label: value };
            }
            if (typeof option === 'object') {
              const rawValue = option.value !== undefined && option.value !== null ? String(option.value).trim() : '';
              if (!rawValue) {
                return null;
              }
              const label = option.label !== undefined && option.label !== null && option.label !== '' ? String(option.label) : rawValue;
              return { value: rawValue, label: label };
            }
            return null;
          })
          .filter(Boolean);
      }

      function mergeOptions(alias, newOptions) {
        if (!Array.isArray(newOptions) || newOptions.length === 0) {
          return;
        }
        if (!state.options[alias]) {
          state.options[alias] = [];
        }
        const existing = state.options[alias];
        const seen = new Set(existing.map((option) => option.value.toLowerCase()));
        newOptions.forEach((option) => {
          const key = option.value.toLowerCase();
          if (!seen.has(key)) {
            existing.push({ value: option.value, label: option.label });
            seen.add(key);
          }
        });
      }

      function sortOptions(alias) {
        if (!state.options[alias]) {
          return;
        }
        const field = FIELD_LOOKUP[alias];
        const staticOptions = normalizeFieldOptions(field && field.options ? field.options : []);
        const staticOrder = new Map();
        staticOptions.forEach((option, index) => {
          staticOrder.set(option.value.toLowerCase(), index);
        });
        state.options[alias].sort((a, b) => {
          const aKey = a.value.toLowerCase();
          const bKey = b.value.toLowerCase();
          const aIndex = staticOrder.has(aKey) ? staticOrder.get(aKey) : Number.POSITIVE_INFINITY;
          const bIndex = staticOrder.has(bKey) ? staticOrder.get(bKey) : Number.POSITIVE_INFINITY;
          if (aIndex !== bIndex) {
            return aIndex - bIndex;
          }
          if (aIndex !== Number.POSITIVE_INFINITY) {
            return 0;
          }
          const aLabel = a.label.toLowerCase();
          const bLabel = b.label.toLowerCase();
          if (aLabel < bLabel) {
            return -1;
          }
          if (aLabel > bLabel) {
            return 1;
          }
          return 0;
        });
      }

      function getOptionsForField(alias) {
        if (!state.options[alias]) {
          state.options[alias] = [];
        }
        return state.options[alias];
      }

      function populateSelectElement(select, options, field) {
        const placeholderText = field.placeholder || 'Selecciona una opci√≥n‚Ä¶';
        const previousValue = select.value;
        select.innerHTML = '';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = placeholderText;
        select.appendChild(placeholder);

        options.forEach((option) => {
          const optionElement = document.createElement('option');
          optionElement.value = option.value;
          optionElement.textContent = option.label;
          select.appendChild(optionElement);
        });

        if (field.allowCustom) {
          const removeOption = document.createElement('option');
          removeOption.value = CUSTOM_OPTION_REMOVE;
          removeOption.textContent = 'üóëÔ∏è Eliminar valor‚Ä¶';
          select.appendChild(removeOption);

          const customOption = document.createElement('option');
          customOption.value = CUSTOM_OPTION_VALUE;
          customOption.textContent = '‚ûï Agregar nuevo valor‚Ä¶';
          select.appendChild(customOption);
        }

        if (previousValue) {
          select.value = previousValue;
        }
      }

      function addCustomOption(alias, value) {
        const trimmed = value ? value.trim() : '';
        if (!trimmed) {
          return;
        }
        mergeOptions(alias, [{ value: trimmed, label: trimmed }]);
        sortOptions(alias);
      }

      function renderSelectField(field) {
        const alias = field.alias;
        const container = elements.formCard.querySelector(`[data-alias="${alias}"]`);
        if (!container) {
          return;
        }
        const select = container.querySelector('select');
        if (!select) {
          return;
        }
        const options = getOptionsForField(alias);
        populateSelectElement(select, options, field);
        const rawValue = state.values[alias];
        const stringValue = rawValue === undefined || rawValue === null ? '' : String(rawValue);
        if (stringValue && !options.some((option) => option.value === stringValue)) {
          addCustomOption(alias, stringValue);
          populateSelectElement(select, getOptionsForField(alias), field);
        }
        select.value = stringValue;
        if (select.dataset.allowCustom === 'true') {
          select.dataset.previousValue = select.value || '';
        }
        updateOptionChip(alias);
      }

      function applyDropdownOptions(optionMap) {
        if (!optionMap) {
          return;
        }
        Object.keys(optionMap).forEach((alias) => {
          const field = FIELD_LOOKUP[alias];
          if (!field || field.valueType !== 'select') {
            return;
          }
          const normalized = normalizeFieldOptions(optionMap[alias]);
          mergeOptions(alias, normalized);
          sortOptions(alias);
        });
      }

      function normalizePermissions(permissions) {
        if (!permissions) {
          return {
            canEdit: true,
            canSync: true,
            canDelete: true,
            canManageAccess: false,
            role: '',
            email: '',
            enabled: true,
            status: '',
          };
        }
        return {
          canEdit: permissions.canEdit !== false,
          canSync: permissions.canSync !== false,
          canDelete: permissions.canDelete !== false,
          canManageAccess: permissions.canManageAccess !== false,
          role: permissions.role || '',
          email: permissions.email || '',
          enabled: permissions.enabled !== false,
          status: permissions.status || '',
        };
      }

      function applyPermissions(permissions) {
        const normalized = normalizePermissions(permissions);
        state.permissions = normalized;
        togglePermissionsCard(normalized.canManageAccess);
        if (normalized.canManageAccess && !state.permissionAdmin.loaded && !state.permissionAdmin.loading) {
          loadPermissionAdminData();
        }
        if (!elements.formCard) {
          updateActionState();
          return;
        }
        const canEdit = normalized.canEdit;
        const editableInputs = elements.formCard.querySelectorAll('input, textarea, select');
        editableInputs.forEach((input) => {
          const role = input.dataset ? input.dataset.role : '';
          if (role === 'link-open') {
            input.disabled = false;
            return;
          }
          if (role === 'link-clear') {
            input.disabled = !canEdit;
            return;
          }
          input.disabled = !canEdit;
        });
        const linkClearButtons = elements.formCard.querySelectorAll('button[data-role="link-clear"]');
        linkClearButtons.forEach((button) => {
          button.disabled = !canEdit;
        });
        updateActionState();
      }

      function attachEventHandlers() {
        elements.reloadButton.addEventListener('click', () => loadContext());
        elements.dictionaryButton.addEventListener('click', openDictionary);
        elements.acceptButton.addEventListener('click', () => submitAction('accept'));
        elements.updateButton.addEventListener('click', () => submitAction('save'));
        elements.cancelButton.addEventListener('click', resetFormToBaseline);
        elements.deleteButton.addEventListener('click', handleDelete);

        elements.formCard.addEventListener('input', handleFieldInput);
        elements.formCard.addEventListener('change', handleFieldInput);
        elements.formCard.addEventListener('focusin', handleFieldFocus);
        elements.formCard.addEventListener('click', handleLinkButtons);

        if (elements.permissionUserForm) {
          elements.permissionUserForm.addEventListener('submit', handlePermissionUserSubmit);
        }
        if (elements.permissionUserResetButton) {
          elements.permissionUserResetButton.addEventListener('click', handlePermissionUserReset);
        }
        if (elements.permissionUserTableBody) {
          elements.permissionUserTableBody.addEventListener('click', handlePermissionUserTableClick);
        }
        if (elements.openPermissionsSheetButton) {
          elements.openPermissionsSheetButton.addEventListener('click', handleOpenPermissionsSheet);
        }
        if (elements.columnPermissionUser) {
          elements.columnPermissionUser.addEventListener('change', handleColumnPermissionUserChange);
        }
        if (elements.columnPermissionList) {
          elements.columnPermissionList.addEventListener('change', handleColumnPermissionToggle);
        }
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.addEventListener('click', handleColumnPermissionSave);
        }
        if (elements.optionModalConfirm) {
          elements.optionModalConfirm.addEventListener('click', handleOptionModalConfirm);
        }
      }

      function handleFieldInput(event) {
        const target = event.target;
        if (!target || !target.dataset) {
          return;
        }
        const alias = target.dataset.alias;
        if (!alias) {
          return;
        }
        const type = target.dataset.type;
        const role = target.dataset.role;

        if (role === 'link-url' || role === 'link-text') {
          updateLinkValue(alias);
          return;
        }

        let value = target.value;
        if (type === 'select') {
          if (target.dataset.allowCustom === 'true') {
            if (value === CUSTOM_OPTION_REMOVE) {
              handleRemoveOption(target, alias);
              return;
            }
            if (value === CUSTOM_OPTION_VALUE) {
              handleCustomSelectValue(target, alias);
              return;
            }
          }
          value = value === undefined || value === null ? '' : String(value);
        }
        if (type === 'boolean') {
          if (value === '') {
            value = null;
          } else {
            value = value === 'true';
          }
        }
        setFieldValue(alias, value);
        maybeApplyContactAutoFill(alias, value);
        if (['moneda', 'monto_ofertado', 'tipo_cambio'].includes(alias)) {
          applyKpiFormulas();
        }
      }

      function handleFieldFocus(event) {
        const target = event.target;
        if (!target || !target.dataset) {
          return;
        }
        if (target.matches('select[data-allow-custom="true"]')) {
          target.dataset.previousValue = target.value || '';
        }
      }

      function handleCustomSelectValue(select, alias) {
        const field = FIELD_LOOKUP[alias];
        const label = field && field.label ? field.label : alias;
        const response = prompt(`Nuevo valor para "${label}"`);
        if (response === null) {
          const previous = select.dataset.previousValue || '';
          select.value = previous;
          return;
        }
        const trimmed = response.trim();
        if (!trimmed) {
          const previous = select.dataset.previousValue || '';
          select.value = previous;
          return;
        }
        addCustomOption(alias, trimmed);
        if (field) {
          renderSelectField(field);
        }
        select.value = trimmed;
        setFieldValue(alias, trimmed);
      }

      function handleLinkButtons(event) {
        const target = event.target;
        if (!target.dataset || !target.dataset.role) {
          return;
        }
        const role = target.dataset.role;
        const alias = target.dataset.alias;
        if (!alias) {
          return;
        }
        if (role === 'link-open') {
          event.preventDefault();
          const value = state.values[alias] || { url: '', text: '' };
          if (value.url) {
            window.open(value.url, '_blank');
          }
        } else if (role === 'link-clear') {
          event.preventDefault();
          state.values[alias] = { url: '', text: '' };
          renderLinkField(alias);
          updateActionState();
        }
      }

      function updateLinkValue(alias) {
        const urlInput = elements.formCard.querySelector(`input[data-role="link-url"][data-alias="${alias}"]`);
        const textInput = elements.formCard.querySelector(`input[data-role="link-text"][data-alias="${alias}"]`);
        const url = urlInput ? urlInput.value.trim() : '';
        const text = textInput ? textInput.value.trim() : '';
        state.values[alias] = { url, text };
        toggleLinkButtons(alias, url);
        updateActionState();
      }

      function setFieldValue(alias, value) {
        if (typeof value === 'string') {
          state.values[alias] = value;
        } else {
          state.values[alias] = value === undefined ? '' : value;
        }
        updateOptionChip(alias);
        updateActionState();
      }

      function toggleLinkButtons(alias, hasUrl) {
        const openButton = elements.formCard.querySelector(`button[data-role="link-open"][data-alias="${alias}"]`);
        if (openButton) {
          openButton.disabled = !hasUrl;
        }
      }

      function openDictionary() {
        setLoading(true, `Abriendo "${DICTIONARY_SHEET_NAME}"‚Ä¶`);
        google.script.run
          .withSuccessHandler(() => {
            setLoading(false);
            setStatus(`Se abri√≥ la hoja "${DICTIONARY_SHEET_NAME}" en el libro.`, 'success');
          })
          .withFailureHandler((error) => {
            setLoading(false);
            showError(error);
          })
          .openColumnDictionarySheet();
      }

      function loadContext() {
        setLoading(true, 'Cargando informaci√≥n de la hoja‚Ä¶');
        state.permissionAdmin.loaded = false;
        state.permissionAdmin.users = [];
        state.permissionAdmin.columns = [];
        state.permissionAdmin.matrix = {};
        state.permissionAdmin.selectedEmail = '';
        if (elements.columnPermissionList) {
          elements.columnPermissionList.innerHTML = '';
        }
        if (elements.columnPermissionUser) {
          elements.columnPermissionUser.value = '';
        }
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.disabled = true;
        }
        setPermissionStatus('', '');
        google.script.run
          .withSuccessHandler((context) => {
            setLoading(false);
            processContext(context);
          })
          .withFailureHandler((error) => {
            setLoading(false);
            showError(error);
          })
          .getSidebarContext();
      }

      function processContext(context) {
        clearStatus();
        hideAlert();

        applyPermissions(context && context.permissions ? context.permissions : null);

        state.contactDirectory = (context && context.contactDirectory) || {};
        state.options = {};
        initializeStaticOptions();
        if (context && context.dropdownOptions) {
          applyDropdownOptions(context.dropdownOptions);
        }

        showFormCards(true);

        const active = context && context.activeInvitation ? context.activeInvitation : null;
        if (!active) {
          resetFormData();
          showAlert('danger', 'No se pudo obtener la informaci√≥n de la hoja.');
          setStatus('Formulario listo. Las acciones se habilitar√°n cuando selecciones una fila.', 'info');
          updateActionState();
          return;
        }

        if (!active.rowNumber) {
          resetFormData();
          if (
            active.sheetName &&
            active.expectedSheetName &&
            active.sheetName !== active.expectedSheetName
          ) {
            showAlert(
              'warning',
              `Abre la hoja "${active.expectedSheetName}" para gestionar las invitaciones. Actualmente est√°s en "${active.sheetName}".`
            );
          } else {
            showAlert('info', 'Selecciona una fila de datos (por debajo del encabezado) para trabajar desde el panel.');
          }
          setStatus('Formulario listo. Las acciones se habilitar√°n cuando selecciones una fila.', 'info');
          updateActionState();
          return;
        }

        hideAlert();
        applyData(active.data || {}, active.rowNumber);
      }

      function applyData(data, rowNumber) {
        state.rowNumber = rowNumber;
        state.baseline = {};
        state.values = {};

        FIELD_SECTIONS.forEach((section) => {
          section.fields.forEach((field) => {
            const alias = field.alias;
            const incoming = Object.prototype.hasOwnProperty.call(data, alias) ? data[alias] : '';
            if (field.valueType === 'boolean') {
              const value = incoming === true ? true : incoming === false ? false : null;
              state.baseline[alias] = value;
              state.values[alias] = value;
            } else if (field.valueType === 'link') {
              const value = {
                url: incoming && incoming.url ? String(incoming.url) : '',
                text: incoming && incoming.text ? String(incoming.text) : '',
              };
              state.baseline[alias] = { ...value };
              state.values[alias] = { ...value };
            } else {
              const stringValue = incoming === null || incoming === undefined ? '' : String(incoming);
              state.baseline[alias] = stringValue;
              state.values[alias] = stringValue;
            }
          });
        });

        renderAllFields();
        updateSummaryCard(data || {});
        if (state.permissions && state.permissions.canEdit === false) {
          setStatus('Panel en modo lectura. Solicita acceso en la hoja de permisos.', 'warning');
        } else {
          clearStatus();
        }
        updateActionState();
      }

      function resetFormData() {
        state.rowNumber = null;
        state.baseline = {};
        state.values = {};

        FIELD_SECTIONS.forEach((section) => {
          section.fields.forEach((field) => {
            const alias = field.alias;
            if (field.valueType === 'boolean') {
              state.baseline[alias] = null;
              state.values[alias] = null;
            } else if (field.valueType === 'link') {
              const emptyLink = { url: '', text: '' };
              state.baseline[alias] = { ...emptyLink };
              state.values[alias] = { ...emptyLink };
            } else {
              state.baseline[alias] = '';
              state.values[alias] = '';
            }
          });
        });

        renderAllFields();
        updateSummaryCard({});
        updateActionState();
      }

      function renderAllFields() {
        FIELD_SECTIONS.forEach((section) => {
          section.fields.forEach((field) => {
            if (field.hidden) {
              return;
            }
            if (field.valueType === 'link') {
              renderLinkField(field.alias);
            } else if (field.valueType === 'select') {
              renderSelectField(field);
            } else {
              renderStandardField(field);
            }
          });
        });
      }

      function renderStandardField(field) {
        const alias = field.alias;
        const container = elements.formCard.querySelector(`[data-alias="${alias}"]`);
        if (!container) {
          return;
        }
        const input = container.querySelector('input, textarea, select');
        if (!input) {
          return;
        }
        const value = state.values[alias];
        if (field.valueType === 'boolean') {
          input.value = value === null ? '' : value ? 'true' : 'false';
        } else {
          input.value = value === undefined || value === null ? '' : String(value);
        }
        updateOptionChip(alias);
      }

      function renderLinkField(alias) {
        const urlInput = elements.formCard.querySelector(`input[data-role="link-url"][data-alias="${alias}"]`);
        const textInput = elements.formCard.querySelector(`input[data-role="link-text"][data-alias="${alias}"]`);
        const value = state.values[alias] || { url: '', text: '' };
        if (urlInput) {
          urlInput.value = value.url || '';
        }
        if (textInput) {
          textInput.value = value.text || '';
        }
        toggleLinkButtons(alias, !!value.url);
      }

      function updateOptionChip() {}

      function applyDependentFieldValue(alias, value, options = {}) {
        const field = FIELD_LOOKUP[alias];
        if (!field) {
          return;
        }
        let storedValue = value;
        if (field.valueType === 'boolean') {
          if (value === '' || value === null || value === undefined) {
            storedValue = null;
          } else if (value === true || value === false) {
            storedValue = value;
          } else {
            storedValue = String(value).toLowerCase() === 'true';
          }
        } else if (field.valueType === 'link') {
          storedValue = value && typeof value === 'object' ? { ...value } : { url: '', text: '' };
        } else if (value === null || value === undefined) {
          storedValue = '';
        } else {
          storedValue = String(value);
        }

        state.values[alias] = storedValue;

        if (!field.hidden) {
          if (field.valueType === 'link') {
            renderLinkField(alias);
          } else if (field.valueType === 'select') {
            if (storedValue && storedValue !== '' && !getOptionsForField(alias).some((opt) => opt.value === storedValue)) {
              addCustomOption(alias, storedValue);
            }
            renderSelectField(field);
          } else {
            renderStandardField(field);
          }
        }

        if (!options.skipActionState) {
          updateActionState();
        }
      }

      function maybeApplyContactAutoFill(alias, value) {
        const directory = state.contactDirectory || {};
        if (!value) {
          return;
        }
        const normalized = value.toString().trim().toLowerCase();
        let entry = null;
        if (alias === 'solicitante' && directory.solicitante) {
          entry = directory.solicitante[normalized] || null;
          if (entry) {
            applyDependentFieldValue('correo_solicitante', entry.email || '', { skipActionState: true });
            applyDependentFieldValue('telefono_solicitante', entry.phone || '', { skipActionState: true });
          }
        } else if (alias === 'responsable_tecnico' && directory.responsable_tecnico) {
          entry = directory.responsable_tecnico[normalized] || null;
          if (entry) {
            applyDependentFieldValue('correo_responsable_tecnico', entry.email || '', { skipActionState: true });
            applyDependentFieldValue('telefono_responsable_tecnico', entry.phone || '', { skipActionState: true });
          }
        } else if (alias === 'responsable_economico' && directory.responsable_economico) {
          entry = directory.responsable_economico[normalized] || null;
          if (entry) {
            applyDependentFieldValue('correo_responsable_economico', entry.email || '', { skipActionState: true });
            applyDependentFieldValue('telefono_responsable_economico', entry.phone || '', { skipActionState: true });
          }
        }
        if (entry) {
          updateActionState();
        }
      }

      function applyKpiFormulas() {
        const moneda = (state.values.moneda || '').toString().trim().toUpperCase();
        const montoRaw = state.values.monto_ofertado;
        const tipoCambioRaw = state.values.tipo_cambio;
        const monto =
          montoRaw === null || montoRaw === undefined || montoRaw === '' ? NaN : Number(montoRaw);
        let tipoCambio =
          tipoCambioRaw === null || tipoCambioRaw === undefined || tipoCambioRaw === ''
            ? NaN
            : Number(tipoCambioRaw);
        let monedaNormalizada = '';
        let montoUsd = '';
        const formatTwoDecimals = (num) =>
          Number.isFinite(num) ? (Math.round(num * 100) / 100).toFixed(2) : '';

        if (!moneda) {
          applyDependentFieldValue('moneda_normalizada_usd', '', { skipActionState: true });
          applyDependentFieldValue('monto_ofertado_usd', '', { skipActionState: true });
          updateActionState();
          return;
        }

        const isUsd = ['USD', 'US$', 'DOLAR', 'D√ìLAR', 'DOLARES', 'D√ìLARES'].includes(moneda);
        const isPen = ['PEN', 'SOL', 'SOLES', 'S/.', 'S/'].includes(moneda);

        if (isUsd) {
          monedaNormalizada = 'USD';
          if (!Number.isFinite(tipoCambio) || tipoCambio === 0) {
            tipoCambio = 1;
            applyDependentFieldValue('tipo_cambio', '1', { skipActionState: true });
          }
          montoUsd = formatTwoDecimals(monto);
        } else if (isPen) {
          monedaNormalizada = 'USD';
          if (Number.isFinite(monto) && Number.isFinite(tipoCambio) && tipoCambio !== 0) {
            const calculado = monto * tipoCambio;
            montoUsd = formatTwoDecimals(calculado);
          } else {
            montoUsd = '';
          }
        } else {
          monedaNormalizada = moneda;
          montoUsd = formatTwoDecimals(monto);
        }

        applyDependentFieldValue('moneda_normalizada_usd', monedaNormalizada, { skipActionState: true });
        applyDependentFieldValue('monto_ofertado_usd', montoUsd, { skipActionState: true });
        updateActionState();
      }

      function handleRemoveOption(select, alias) {
        const field = FIELD_LOOKUP[alias];
        const previous = select.dataset.previousValue || '';
        select.value = previous;
        const options = getOptionsForField(alias).filter((option) => option && option.value);
        if (!options.length) {
          showAlert('info', `No hay valores registrados en "${field.label}" para eliminar.`);
          return;
        }
        openOptionRemovalModal(
          alias,
          field,
          options.map((option) => ({ value: option.value, label: option.label })),
          previous
        );
      }

      function updateSummaryCard(data) {
        const hasRow = !!state.rowNumber;
        const title = data.cotizacion
          ? `Cotizaci√≥n ${data.cotizacion}`
          : data.descripcion
          ? data.descripcion
          : hasRow
          ? `Fila ${state.rowNumber}`
          : 'Formulario disponible';
        elements.summaryTitle.textContent = title;

        const subtitle = data.cliente
          ? data.cliente
          : data.orden_de_compra
          ? `Orden de compra: ${data.orden_de_compra}`
          : hasRow
          ? 'Cliente no especificado'
          : 'Selecciona una fila para cargar los datos.';
        elements.summarySubtitle.textContent = subtitle;

        const badgeText = data.orden_de_compra
          ? `OC ${data.orden_de_compra}`
          : data.semana_iso
          ? `Semana ${data.semana_iso}`
          : hasRow && state.rowNumber
          ? `Fila ${state.rowNumber}`
          : 'Sin fila seleccionada';
        elements.summaryBadge.textContent = badgeText;

        elements.summaryDescription.textContent = data.descripcion
          ? data.descripcion
          : hasRow
          ? 'Sin descripci√≥n registrada.'
          : 'Utiliza los botones superiores para actualizar la fila que selecciones en la hoja.';

        elements.summaryStatuses.innerHTML = '';
        const statuses = [
          { label: 'Servicio', value: data.tipo_servicio, tone: 'palette' },
          { label: 'Cotizaci√≥n', value: data.estado_cotizacion, tone: 'primary' },
          { label: 'Propuesta', value: data.estado_propuesta, tone: 'success' },
          { label: 'Pipeline', value: data.estado_pipeline, tone: 'warning' },
        ];
        statuses.forEach((status) => {
          if (!status.value) {
            return;
          }
          const badge = document.createElement('span');
          let toneClass = 'badge-soft-primary';
          if (status.tone === 'success') {
            toneClass = 'badge-soft-success';
          } else if (status.tone === 'warning') {
            toneClass = 'badge-soft-warning';
          }
          if (status.tone === 'palette') {
            const palette = FIELD_LOOKUP.tipo_servicio && FIELD_LOOKUP.tipo_servicio.palette;
            const normalized = status.value.toString().trim().toLowerCase();
            const color = palette ? palette[normalized] : null;
            badge.className = 'status-badge';
            badge.style.backgroundColor = color ? color + '1a' : 'rgba(99, 102, 241, 0.12)';
            badge.style.color = color || '#4338ca';
          } else {
            badge.className = `status-badge ${toneClass}`;
          }
          badge.textContent = `${status.label}: ${status.value}`;
          elements.summaryStatuses.appendChild(badge);
        });
      }

      function setAdminControlsEnabled(enabled) {
        const disable = !enabled || state.permissionAdmin.loading;
        if (elements.permissionUserForm) {
          Array.from(elements.permissionUserForm.elements).forEach((input) => {
            if (!input) {
              return;
            }
            input.disabled = disable;
          });
        }
        if (elements.permissionUserSubmitButton) {
          elements.permissionUserSubmitButton.disabled = disable;
        }
        if (elements.permissionUserResetButton) {
          elements.permissionUserResetButton.disabled = disable;
        }
        if (elements.openPermissionsSheetButton) {
          elements.openPermissionsSheetButton.disabled = disable;
        }
        if (elements.columnPermissionUser) {
          elements.columnPermissionUser.disabled = disable;
        }
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.disabled =
            disable || !state.permissionAdmin.selectedEmail;
        }
        if (elements.columnPermissionList) {
          const checkboxes = elements.columnPermissionList.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach((checkbox) => {
            checkbox.disabled = disable;
          });
        }
      }

      function togglePermissionsCard(canManage) {
        if (elements.adminTabItem) {
          elements.adminTabItem.classList.remove('d-none');
        }
        if (elements.adminTabPane) {
          elements.adminTabPane.classList.remove('d-none');
        }
        if (elements.permissionsCard) {
          elements.permissionsCard.classList.remove('d-none');
        }
        if (elements.adminTabButton) {
          elements.adminTabButton.classList.remove('d-none');
          elements.adminTabButton.disabled = false;
          elements.adminTabButton.setAttribute('aria-disabled', 'false');
        }

        if (canManage === true) {
          setPermissionStatus('', '');
          setAdminControlsEnabled(true);
          return;
        }

        state.permissionAdmin.loading = false;
        state.permissionAdmin.loaded = false;
        state.permissionAdmin.users = [];
        state.permissionAdmin.columns = [];
        state.permissionAdmin.matrix = {};
        state.permissionAdmin.selectedEmail = '';
        state.permissionAdmin.editingEmail = '';
        setPermissionStatus('Tu usuario no tiene permisos de administraci√≥n.', 'warning');
        resetPermissionUserForm();
        setAdminControlsEnabled(false);
        if (elements.permissionUserTableBody) {
          elements.permissionUserTableBody.innerHTML = '';
        }
        if (elements.columnPermissionList) {
          elements.columnPermissionList.innerHTML = '';
        }
        if (elements.columnPermissionUser) {
          elements.columnPermissionUser.value = '';
        }
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.disabled = true;
        }
      }

      function setPermissionStatus(message, tone) {
        if (!elements.permissionStatus) {
          return;
        }
        elements.permissionStatus.textContent = message || '';
        elements.permissionStatus.classList.remove('text-success', 'text-danger', 'text-warning', 'text-muted');
        if (!message) {
          return;
        }
        let className = 'text-muted';
        if (tone === 'success') {
          className = 'text-success';
        } else if (tone === 'warning') {
          className = 'text-warning';
        } else if (tone === 'danger') {
          className = 'text-danger';
        } else if (tone === 'info') {
          className = 'text-primary';
        }
        elements.permissionStatus.classList.add(className);
      }

      function setPermissionAdminLoading(isLoading, statusMessage) {
        state.permissionAdmin.loading = isLoading;
        if (statusMessage !== undefined) {
          setPermissionStatus(statusMessage, isLoading ? 'info' : undefined);
        }
        if (elements.permissionUserForm) {
          Array.from(elements.permissionUserForm.elements).forEach((input) => {
            input.disabled = isLoading;
          });
        }
        if (elements.openPermissionsSheetButton) {
          elements.openPermissionsSheetButton.disabled = isLoading;
        }
        if (elements.columnPermissionUser) {
          elements.columnPermissionUser.disabled = isLoading;
        }
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.disabled =
            isLoading || !state.permissionAdmin.selectedEmail;
        }
        if (elements.columnPermissionList) {
          const inputs = elements.columnPermissionList.querySelectorAll('input[type="checkbox"]');
          inputs.forEach((checkbox) => {
            checkbox.disabled = isLoading;
          });
        }
      }

      function loadPermissionAdminData(options = {}) {
        if (!state.permissions || state.permissions.canManageAccess !== true) {
          togglePermissionsCard(false);
          return;
        }
        const silent = !!(options && options.silent);
        setPermissionAdminLoading(true, silent ? undefined : 'Cargando configuraci√≥n de permisos‚Ä¶');
        google.script.run
          .withSuccessHandler((data) => {
            setPermissionAdminLoading(false);
            state.permissionAdmin.loaded = true;
            applyPermissionAdminData(data || {});
            if (silent) {
              return;
            }
            if (state.permissionAdmin.users.length) {
              setPermissionStatus('Permisos cargados correctamente.', 'success');
            } else {
              setPermissionStatus('No hay usuarios registrados todav√≠a.', 'warning');
            }
          })
          .withFailureHandler((error) => {
            setPermissionAdminLoading(false);
            showError(error);
          })
          .getPermissionManagementData();
      }

      function applyPermissionAdminData(data) {
        const users = Array.isArray(data.users) ? data.users.slice() : [];
        users.sort((a, b) => {
          const aEmail = (a.email || '').toLowerCase();
          const bEmail = (b.email || '').toLowerCase();
          if (aEmail < bEmail) {
            return -1;
          }
          if (aEmail > bEmail) {
            return 1;
          }
          return 0;
        });
        state.permissionAdmin.users = users;
        state.permissionAdmin.columns = Array.isArray(data.columns) ? data.columns.slice() : [];
        state.permissionAdmin.matrix = data.matrix && typeof data.matrix === 'object' ? data.matrix : {};
        const previous = state.permissionAdmin.selectedEmail;
        const hasPrevious = previous && users.some((user) => user.email === previous);
        state.permissionAdmin.selectedEmail = hasPrevious
          ? previous
          : users.length
          ? users[0].email
          : '';
        if (state.permissionAdmin.editingEmail) {
          const editingUser = users.find((user) => user.email === state.permissionAdmin.editingEmail);
          if (editingUser) {
            populatePermissionUserForm(editingUser, { preserveMode: true });
          } else {
            resetPermissionUserForm();
          }
        }
        renderPermissionUsersTable();
        populateColumnPermissionUserSelect();
        renderColumnPermissionList();
      }

      function normalizeRoleLabel(role) {
        const value = (role || '').toUpperCase();
        if (value === 'ADMIN') {
          return 'Administrador';
        }
        if (value === 'EDITOR') {
          return 'Editor';
        }
        if (value === 'LECTOR') {
          return 'Lector';
        }
        return value || 'Sin rol';
      }

      function renderPermissionUsersTable() {
        if (!elements.permissionUserTableBody) {
          return;
        }
        const tbody = elements.permissionUserTableBody;
        tbody.innerHTML = '';
        if (!state.permissionAdmin.users.length) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 6;
          cell.className = 'text-muted small';
          cell.textContent = 'Registra un usuario para gestionar accesos.';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }
        state.permissionAdmin.users.forEach((user) => {
          const row = document.createElement('tr');
          const statusValue = (user.status || '').toString() || (user.enabled === false ? 'Deshabilitado' : 'Habilitado');
          const isDisabled = statusValue.toLowerCase() === 'deshabilitado';
          if (isDisabled) {
            row.classList.add('table-warning');
          }
          const emailCell = document.createElement('td');
          emailCell.textContent = user.email || '';
          const phoneCell = document.createElement('td');
          phoneCell.textContent = user.phone ? user.phone : '‚Äî';
          const roleCell = document.createElement('td');
          roleCell.textContent = normalizeRoleLabel(user.role);
          const statusCell = document.createElement('td');
          const statusBadge = document.createElement('span');
          statusBadge.className = isDisabled
            ? 'badge bg-warning-subtle text-warning-emphasis'
            : 'badge bg-success-subtle text-success-emphasis';
          statusBadge.textContent = isDisabled ? 'Deshabilitado' : 'Habilitado';
          statusCell.appendChild(statusBadge);
          const notesCell = document.createElement('td');
          notesCell.textContent = user.notes || '';
          const actionsCell = document.createElement('td');
          actionsCell.className = 'text-end';
          const editButton = document.createElement('button');
          editButton.type = 'button';
          editButton.className = 'btn btn-link btn-sm text-decoration-none';
          editButton.dataset.role = 'permission-edit';
          editButton.dataset.email = user.email || '';
          editButton.textContent = 'Editar';
          editButton.disabled = state.permissionAdmin.loading;
          actionsCell.appendChild(editButton);
          row.appendChild(emailCell);
          row.appendChild(phoneCell);
          row.appendChild(roleCell);
          row.appendChild(statusCell);
          row.appendChild(notesCell);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        });
      }

      function resetPermissionUserForm() {
        if (elements.permissionUserForm) {
          elements.permissionUserForm.reset();
        }
        if (elements.permissionUserEmail) {
          elements.permissionUserEmail.disabled = false;
          elements.permissionUserEmail.value = '';
        }
        if (elements.permissionUserPhone) {
          elements.permissionUserPhone.value = '';
        }
        if (elements.permissionUserRole) {
          elements.permissionUserRole.value = 'ADMIN';
        }
        if (elements.permissionUserStatus) {
          elements.permissionUserStatus.value = 'Habilitado';
        }
        if (elements.permissionUserNotes) {
          elements.permissionUserNotes.value = '';
        }
        if (elements.permissionUserSubmitButton) {
          elements.permissionUserSubmitButton.textContent = 'Registrar';
        }
        state.permissionAdmin.editingEmail = '';
      }

      function populatePermissionUserForm(user, options = {}) {
        if (!user) {
          return;
        }
        state.permissionAdmin.editingEmail = user.email || '';
        if (elements.permissionUserEmail) {
          elements.permissionUserEmail.value = user.email || '';
          elements.permissionUserEmail.disabled = true;
        }
        if (elements.permissionUserPhone) {
          elements.permissionUserPhone.value = user.phone || '';
        }
        if (elements.permissionUserRole) {
          const roleValue = (user.role || 'LECTOR').toUpperCase();
          elements.permissionUserRole.value = roleValue;
        }
        if (elements.permissionUserStatus) {
          const statusValue = user.status || (user.enabled === false ? 'Deshabilitado' : 'Habilitado');
          elements.permissionUserStatus.value = statusValue;
        }
        if (elements.permissionUserNotes) {
          elements.permissionUserNotes.value = user.notes || '';
        }
        if (elements.permissionUserSubmitButton) {
          elements.permissionUserSubmitButton.textContent = 'Actualizar';
        }
      }

      function handlePermissionUserReset(event) {
        event.preventDefault();
        if (state.permissionAdmin.loading) {
          return;
        }
        resetPermissionUserForm();
        setPermissionStatus('Formulario listo para registrar un nuevo usuario.', 'info');
      }

      function handlePermissionUserTableClick(event) {
        const button = event.target.closest('button[data-role="permission-edit"]');
        if (!button || state.permissionAdmin.loading) {
          return;
        }
        const email = (button.dataset.email || '').toLowerCase();
        if (!email) {
          return;
        }
        const user = state.permissionAdmin.users.find((candidate) => candidate.email === email);
        if (!user) {
          setPermissionStatus('No se encontr√≥ el usuario seleccionado.', 'warning');
          return;
        }
        populatePermissionUserForm(user);
        if (elements.permissionUserSubmitButton) {
          elements.permissionUserSubmitButton.textContent = 'Actualizar';
        }
        state.permissionAdmin.selectedEmail = email;
        if (elements.columnPermissionUser) {
          elements.columnPermissionUser.value = email;
        }
        renderColumnPermissionList();
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.disabled =
            state.permissionAdmin.loading || !state.permissionAdmin.selectedEmail;
        }
        setPermissionStatus(`Editando permisos para ${user.email}.`, 'info');
      }

      function populateColumnPermissionUserSelect() {
        if (!elements.columnPermissionUser) {
          return;
        }
        const select = elements.columnPermissionUser;
        const selected = state.permissionAdmin.selectedEmail;
        select.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecciona un usuario‚Ä¶';
        select.appendChild(placeholder);
        state.permissionAdmin.users.forEach((user) => {
          const option = document.createElement('option');
          option.value = user.email || '';
          const roleLabel = normalizeRoleLabel(user.role);
          const statusValue = (user.status || '').toString() || (user.enabled === false ? 'Deshabilitado' : 'Habilitado');
          let optionLabel = user.email || '';
          if (roleLabel) {
            optionLabel += ` ¬∑ ${roleLabel}`;
          }
          if (statusValue.toLowerCase() === 'deshabilitado') {
            optionLabel += ' ¬∑ Deshabilitado';
          }
          option.textContent = optionLabel.trim();
          select.appendChild(option);
        });
        if (selected && state.permissionAdmin.users.some((user) => user.email === selected)) {
          select.value = selected;
        } else {
          select.value = state.permissionAdmin.selectedEmail || '';
        }
      }

      function ensurePermissionMatrixEntry(email) {
        const normalized = (email || '').toLowerCase();
        if (!normalized) {
          return {};
        }
        if (!state.permissionAdmin.matrix[normalized]) {
          state.permissionAdmin.matrix[normalized] = {};
        }
        return state.permissionAdmin.matrix[normalized];
      }

      function groupColumnsBySection(columns) {
        const groups = {};
        (columns || []).forEach((column) => {
          const sectionId = column.section || 'otros';
          if (!groups[sectionId]) {
            groups[sectionId] = [];
          }
          groups[sectionId].push(column);
        });
        return groups;
      }

      function getSectionLabel(sectionId) {
        const section = FIELD_SECTIONS.find((candidate) => candidate.id === sectionId);
        return (section && section.title) || sectionId;
      }

      function renderColumnPermissionList() {
        if (!elements.columnPermissionList) {
          return;
        }
        const container = elements.columnPermissionList;
        container.innerHTML = '';
        const email = state.permissionAdmin.selectedEmail;
        if (!email) {
          const placeholder = document.createElement('div');
          placeholder.className = 'col-12';
          placeholder.innerHTML =
            '<div class="text-muted small">Selecciona un usuario para ajustar la visibilidad.</div>';
          container.appendChild(placeholder);
          if (elements.columnPermissionSaveButton) {
            elements.columnPermissionSaveButton.disabled = true;
          }
          return;
        }
        const matrix = ensurePermissionMatrixEntry(email);
        const columns = (state.permissionAdmin.columns || []).filter(
          (column) => column.alias !== 'invitation_id'
        );
        if (!columns.length) {
          const placeholder = document.createElement('div');
          placeholder.className = 'col-12';
          placeholder.innerHTML = '<div class="text-muted small">No hay columnas disponibles para configurar.</div>';
          container.appendChild(placeholder);
          return;
        }
        const groups = groupColumnsBySection(columns);
        Object.keys(groups).forEach((sectionId) => {
          const sectionColumns = groups[sectionId];
          const wrapper = document.createElement('div');
          wrapper.className = 'col-12';
          const card = document.createElement('div');
          card.className = 'border rounded-3 p-3 bg-light';
          const title = document.createElement('h4');
          title.className = 'h6 fw-semibold text-primary mb-3';
          title.textContent = getSectionLabel(sectionId);
          card.appendChild(title);
          const row = document.createElement('div');
          row.className = 'row g-2';
          sectionColumns.forEach((column) => {
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6';
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check form-switch';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input';
            checkbox.id = `column-permission-${sectionId}-${column.alias}`;
            checkbox.dataset.role = 'column-permission';
            checkbox.dataset.alias = column.alias;
            checkbox.checked = matrix[column.alias] !== false;
            const label = document.createElement('label');
            label.className = 'form-check-label small';
            label.setAttribute('for', checkbox.id);
            label.textContent = column.header;
            formCheck.appendChild(checkbox);
            formCheck.appendChild(label);
            col.appendChild(formCheck);
            row.appendChild(col);
          });
          card.appendChild(row);
          wrapper.appendChild(card);
          container.appendChild(wrapper);
        });
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.disabled = state.permissionAdmin.loading;
        }
      }

      function handlePermissionUserSubmit(event) {
        event.preventDefault();
        if (state.permissionAdmin.loading) {
          return;
        }
        const email = elements.permissionUserEmail
          ? elements.permissionUserEmail.value.trim().toLowerCase()
          : '';
        if (!email) {
          setPermissionStatus('Ingresa un correo electr√≥nico v√°lido.', 'warning');
          return;
        }
        const phone = elements.permissionUserPhone ? elements.permissionUserPhone.value.trim() : '';
        const role = elements.permissionUserRole
          ? elements.permissionUserRole.value.trim().toUpperCase()
          : 'LECTOR';
        const status = elements.permissionUserStatus
          ? (elements.permissionUserStatus.value || 'Habilitado').trim()
          : 'Habilitado';
        const notes = elements.permissionUserNotes ? elements.permissionUserNotes.value.trim() : '';
        const payload = { email, phone, role, status, notes };
        const isUpdate = state.permissionAdmin.editingEmail === email;
        setPermissionAdminLoading(true, isUpdate ? 'Actualizando usuario‚Ä¶' : 'Registrando usuario‚Ä¶');
        google.script.run
          .withSuccessHandler(() => {
            setPermissionAdminLoading(false);
            setPermissionStatus(
              isUpdate ? `Usuario ${email} actualizado.` : `Usuario ${email} registrado.`,
              'success'
            );
            resetPermissionUserForm();
            state.permissionAdmin.loaded = false;
            loadPermissionAdminData({ silent: true });
          })
          .withFailureHandler((error) => {
            setPermissionAdminLoading(false);
            showError(error);
          })
          .upsertPermissionUser(payload);
      }

      function handleOpenPermissionsSheet() {
        if (state.permissionAdmin.loading) {
          return;
        }
        setPermissionAdminLoading(true, `Abriendo hoja "${PERMISSIONS_SHEET_NAME}"‚Ä¶`);
        google.script.run
          .withSuccessHandler(() => {
            setPermissionAdminLoading(false);
            setPermissionStatus(`Se abri√≥ "${PERMISSIONS_SHEET_NAME}".`, 'success');
          })
          .withFailureHandler((error) => {
            setPermissionAdminLoading(false);
            showError(error);
          })
          .openPermissionsSheet();
      }

      function handleColumnPermissionUserChange(event) {
        if (state.permissionAdmin.loading) {
          return;
        }
        const email = (event.target.value || '').toLowerCase();
        state.permissionAdmin.selectedEmail = email;
        renderColumnPermissionList();
        if (elements.columnPermissionSaveButton) {
          elements.columnPermissionSaveButton.disabled =
            state.permissionAdmin.loading || !state.permissionAdmin.selectedEmail;
        }
      }

      function handleColumnPermissionToggle(event) {
        const target = event.target;
        if (!target || target.dataset.role !== 'column-permission') {
          return;
        }
        const email = state.permissionAdmin.selectedEmail;
        if (!email) {
          return;
        }
        const alias = target.dataset.alias;
        if (!alias) {
          return;
        }
        const matrix = ensurePermissionMatrixEntry(email);
        matrix[alias] = target.checked;
      }

      function collectColumnPermissionSnapshot(email) {
        const snapshot = {};
        if (!elements.columnPermissionList || !email) {
          return snapshot;
        }
        const checkboxes = elements.columnPermissionList.querySelectorAll('input[data-role="column-permission"]');
        checkboxes.forEach((checkbox) => {
          const alias = checkbox.dataset.alias;
          if (!alias) {
            return;
          }
          snapshot[alias] = checkbox.checked;
        });
        return snapshot;
      }

      function handleColumnPermissionSave() {
        if (state.permissionAdmin.loading) {
          return;
        }
        const email = state.permissionAdmin.selectedEmail;
        if (!email) {
          setPermissionStatus('Selecciona un usuario para guardar la visibilidad.', 'warning');
          return;
        }
        const snapshot = collectColumnPermissionSnapshot(email);
        setPermissionAdminLoading(true, 'Guardando visibilidad‚Ä¶');
        google.script.run
          .withSuccessHandler((response) => {
            setPermissionAdminLoading(false);
            setPermissionStatus('Visibilidad actualizada correctamente.', 'success');
            if (response && response.columns) {
              state.permissionAdmin.matrix[email] = response.columns;
              renderColumnPermissionList();
            }
          })
          .withFailureHandler((error) => {
            setPermissionAdminLoading(false);
            showError(error);
          })
          .saveColumnPermissionsForUser({ email, columns: snapshot });
      }

      function populateOptionModalSelect(options) {
        if (!elements.optionModalSelect) {
          return;
        }
        const select = elements.optionModalSelect;
        select.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecciona un valor‚Ä¶';
        select.appendChild(placeholder);
        options.forEach((option) => {
          const optionElement = document.createElement('option');
          optionElement.value = option.value;
          optionElement.textContent = option.label;
          select.appendChild(optionElement);
        });
      }

      function resetOptionModalState() {
        state.optionRemoval = {
          alias: '',
          options: [],
          previousValue: '',
        };
        if (elements.optionModalSelect) {
          elements.optionModalSelect.value = '';
        }
      }

      function openOptionRemovalModal(alias, field, options, previousValue) {
        if (!state.optionModalInstance || !elements.optionModalTitle) {
          return;
        }
        state.optionRemoval = {
          alias,
          options,
          previousValue,
        };
        const title = field && field.label ? `Eliminar valor ‚Äî ${field.label}` : 'Eliminar valor';
        elements.optionModalTitle.textContent = title;
        populateOptionModalSelect(options);
        state.optionModalInstance.show();
      }

      function handleOptionModalConfirm() {
        if (!state.optionRemoval.alias) {
          state.optionModalInstance && state.optionModalInstance.hide();
          return;
        }
        if (!elements.optionModalSelect) {
          return;
        }
        const value = elements.optionModalSelect.value;
        if (!value) {
          showAlert('warning', 'Selecciona un valor para eliminar.');
          return;
        }
        const match = state.optionRemoval.options.find((option) => option.value === value);
        if (!match) {
          state.optionModalInstance && state.optionModalInstance.hide();
          return;
        }
        state.optionModalInstance.hide();
        setLoading(true, 'Eliminando valor de la lista‚Ä¶');
        google.script.run
          .withSuccessHandler((result) => {
            setLoading(false);
            setStatus(
              result && result.removed
                ? `Se elimin√≥ "${match.label}" de ${result.removed} fila(s).`
                : `No se encontraron coincidencias para "${match.label}".`,
              result && result.removed ? 'success' : 'warning'
            );
            loadContext();
          })
          .withFailureHandler((error) => {
            setLoading(false);
            showError(error);
          })
          .removeDropdownValue({ alias: state.optionRemoval.alias, value: match.value });
      }

      function showFormCards(visible) {
        const method = visible ? 'remove' : 'add';
        elements.summaryCard.classList[method]('d-none');
        elements.formCard.classList[method]('d-none');
        elements.actionsCard.classList[method]('d-none');
      }

      function isDirty() {
        return FIELD_SECTIONS.some((section) =>
          section.fields.some((field) => !valuesAreEqual(state.values[field.alias], state.baseline[field.alias]))
        );
      }

      function valuesAreEqual(a, b) {
        if (typeof a === 'object' && a !== null && typeof b === 'object' && b !== null) {
          return JSON.stringify(a) === JSON.stringify(b);
        }
        return a === b;
      }

      function updateActionState() {
        const hasRow = !!state.rowNumber;
        const dirty = hasRow && isDirty();
        const disabled = !hasRow || state.loading;
        const canEdit = state.permissions && state.permissions.canEdit !== false;
        const canSync = state.permissions && state.permissions.canSync !== false;
        const canDelete = state.permissions && state.permissions.canDelete !== false;

        elements.acceptButton.disabled = disabled || !canSync;
        elements.updateButton.disabled = disabled || !dirty || !canEdit;
        elements.cancelButton.disabled = disabled || !dirty;
        elements.deleteButton.disabled = disabled || !canDelete;
        elements.reloadButton.disabled = state.loading;
        if (elements.dictionaryButton) {
          elements.dictionaryButton.disabled = state.loading;
        }
      }

      function buildUpdatesPayload() {
        const updates = {};
        FIELD_SECTIONS.forEach((section) => {
          section.fields.forEach((field) => {
            const alias = field.alias;
            const value = state.values[alias];
            if (field.valueType === 'boolean') {
              updates[alias] = value === null ? '' : value;
            } else {
              updates[alias] = value === undefined ? '' : value;
            }
          });
        });
        return updates;
      }

      function submitAction(mode) {
        if (!state.rowNumber) {
          return;
        }
        if (mode === 'accept' && state.permissions && state.permissions.canSync === false) {
          setStatus('No tienes permisos para sincronizar con Supabase.', 'error');
          return;
        }
        if (mode !== 'accept' && state.permissions && state.permissions.canEdit === false) {
          setStatus('No tienes permisos para actualizar esta invitaci√≥n.', 'error');
          return;
        }
        const updates = buildUpdatesPayload();
        const request = { rowNumber: state.rowNumber, updates };
        const isAccept = mode === 'accept';
        setLoading(true, isAccept ? 'Sincronizando invitaci√≥n‚Ä¶' : 'Guardando cambios‚Ä¶');

        const runner = google.script.run
          .withSuccessHandler((response) => {
            setLoading(false);
            if (response && response.data) {
              applyData(response.data, response.rowNumber);
            }
            if (isAccept && response && typeof response.syncedRows === 'number') {
              setStatus(`Sincronizaci√≥n exitosa: ${response.syncedRows} registro(s) enviados a Supabase.`, 'success');
            } else {
              setStatus('Cambios guardados correctamente.', 'success');
            }
          })
          .withFailureHandler((error) => {
            setLoading(false);
            showError(error);
          });

        if (isAccept) {
          runner.acceptInvitation(request);
        } else {
          runner.saveInvitation(request);
        }
      }

      function resetFormToBaseline() {
        FIELD_SECTIONS.forEach((section) => {
          section.fields.forEach((field) => {
            const alias = field.alias;
            const baselineValue = state.baseline[alias];
            if (field.valueType === 'link') {
              state.values[alias] = baselineValue ? { ...baselineValue } : { url: '', text: '' };
            } else {
              state.values[alias] = baselineValue;
            }
          });
        });
        renderAllFields();
        clearStatus();
        updateActionState();
      }

      function handleDelete() {
        if (!state.rowNumber || state.loading) {
          return;
        }
        if (state.permissions && state.permissions.canDelete === false) {
          setStatus('Solo un administrador puede eliminar registros desde este panel.', 'error');
          return;
        }
        const confirmed = confirm(
          `¬øEliminar la fila ${state.rowNumber} de la hoja "${SHEET_NAME}"? Esta acci√≥n no se puede deshacer.`
        );
        if (!confirmed) {
          return;
        }
        setLoading(true, 'Eliminando fila seleccionada‚Ä¶');
        google.script.run
          .withSuccessHandler(() => {
            setLoading(false);
            setStatus('Fila eliminada correctamente. Selecciona otra fila para continuar.', 'success');
            state.rowNumber = null;
            state.values = {};
            state.baseline = {};
            showFormCards(false);
            updateActionState();
            loadContext();
          })
          .withFailureHandler((error) => {
            setLoading(false);
            showError(error);
          })
          .deleteInvitation({ rowNumber: state.rowNumber });
      }

      function setLoading(isLoading, message) {
        state.loading = isLoading;
        if (message) {
          elements.loadingMessage.textContent = message;
        }
        elements.loadingOverlay.classList.toggle('d-none', !isLoading);
        updateActionState();
      }

      function setStatus(message, tone) {
        elements.statusMessage.textContent = message || '';
        elements.statusMessage.className = 'form-text mt-2';
        if (!message) {
          return;
        }
        if (tone === 'success') {
          elements.statusMessage.classList.add('text-success');
        } else if (tone === 'error') {
          elements.statusMessage.classList.add('text-danger');
        } else if (tone === 'warning') {
          elements.statusMessage.classList.add('text-warning');
        } else {
          elements.statusMessage.classList.add('text-muted');
        }
      }

      function clearStatus() {
        setStatus('', 'info');
      }

      function showAlert(tone, message) {
        const toneClass =
          tone === 'danger'
            ? 'alert-danger'
            : tone === 'warning'
            ? 'alert-warning'
            : tone === 'info'
            ? 'alert-info'
            : 'alert-secondary';
        elements.alertContainer.innerHTML = `
          <div class="alert ${toneClass}" role="alert">
            ${message}
          </div>
        `;
      }

      function hideAlert() {
        elements.alertContainer.innerHTML = '';
      }

      function showError(error) {
        const message = error && error.message ? error.message : String(error);
        setStatus(message, 'error');
      }
    </script>
  </body>
</html>
